<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nebula Cloud | Fixed</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #05070a; --surface: #0f121d; --accent: #6366f1;
            --text: #f8fafc; --text-dim: #64748b; --border: rgba(255,255,255,0.06);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { height: 100%; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
        
        /* Loading Overlay to prevent screen jumping */
        #master-loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .screen { height: 100vh; width: 100%; padding: 20px; display: none; overflow-y: auto; }
        .active { display: block !important; }
        .hidden { display: none !important; }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; }
        .nav-item { color: var(--text-dim); font-size: 0.7rem; font-weight: 800; text-transform: uppercase; cursor: pointer; }
        .nav-item.active { color: var(--accent); }

        .card { background: var(--surface); border: 1px solid var(--border); padding: 15px; border-radius: 15px; margin-bottom: 10px; }
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; background: var(--accent); color: white; width: 100%; }
        input { width: 100%; padding: 15px; margin-bottom: 10px; background: var(--surface); border: 1px solid var(--border); color: white; border-radius: 10px; }
    </style>
</head>
<body>

<div id="master-loader">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-size:0.7rem; letter-spacing:2px; color:var(--text-dim);">SYNCING CLOUD...</p>
</div>

<div id="auth-screen" class="screen" style="padding-top: 20vh;">
    <h1 style="font-weight:800; margin-bottom:10px;">NEBULA<span style="color:var(--accent);">.</span></h1>
    <p style="color:var(--text-dim); margin-bottom:30px; font-size:0.9rem;">Sign in to manage your hosts</p>
    <input id="email" type="email" placeholder="Email Address">
    <input id="password" type="password" placeholder="Password">
    <button class="btn" onclick="handleAuth()">CONTINUE</button>
</div>

<div id="app-ui" class="hidden">
    <div id="home-screen" class="screen">
        <h2 style="margin-bottom:20px;">DASHBOARD</h2>
        <button class="btn" onclick="createProject()" style="margin-bottom:20px;">+ NEW PROJECT</button>
        <div id="project-list"></div>
    </div>

    <div id="profile-screen" class="screen">
        <h2>PROFILE</h2>
        <div class="card" style="margin-top:20px; text-align:center;">
            <p id="user-email" style="font-weight:700; margin-bottom:20px;"></p>
            <button class="btn" onclick="auth.signOut()" style="background:#ef4444;">LOGOUT</button>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="showScreen('home-screen', this)">Home</div>
        <div class="nav-item" onclick="showScreen('profile-screen', this)">Profile</div>
    </nav>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDSCU7uFxMBi5W3OQHb55rZz3_hXROZRdI",
    authDomain: "zor-battle.firebaseapp.com",
    databaseURL: "https://zor-battle-default-rtdb.firebaseio.com",
    projectId: "zor-battle",
    storageBucket: "zor-battle.firebasestorage.app",
    messagingSenderId: "305211042481",
    appId: "1:305211042481:web:6ebef4c35e2abd80bb9090"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// --- THE FIX: Observer with Screen Management ---
auth.onAuthStateChanged(user => {
    const loader = document.getElementById('master-loader');
    const authScreen = document.getElementById('auth-screen');
    const appUI = document.getElementById('app-ui');

    if (user) {
        // User Logged In
        authScreen.classList.remove('active');
        appUI.classList.remove('hidden');
        document.getElementById('home-screen').classList.add('active');
        document.getElementById('user-email').innerText = user.email;
        loadProjects();
    } else {
        // User Logged Out
        appUI.classList.add('hidden');
        authScreen.classList.add('active');
    }
    // Hide loader only after state is determined
    loader.classList.add('hidden');
});

function showScreen(id, el) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active');
}

function loadProjects() {
    const uid = auth.currentUser.uid;
    db.ref(`users/${uid}/projects`).on('value', snap => {
        const list = document.getElementById('project-list');
        list.innerHTML = "";
        const data = snap.val() || {};
        Object.keys(data).forEach(key => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<strong>${key}</strong> <br> <small style="color:var(--text-dim)">Live & Active</small>`;
            list.appendChild(div);
        });
    });
}

function createProject() {
    const name = prompt("Project Name:");
    if(!name) return;
    db.ref(`users/${auth.currentUser.uid}/projects/${name}`).set({ code: "<h1>Hello</h1>" });
}

async function handleAuth() {
    const e = email.value, p = password.value;
    if(!e || !p) return alert("Enter details");
    try { await auth.signInWithEmailAndPassword(e, p); }
    catch { await auth.createUserWithEmailAndPassword(e, p); }
}
</script>
</body>
</html>
