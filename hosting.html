<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula Cloud | Web Hosting Panel</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            /* Light Mode Default */
            --bg-color: #f3f4f6;
            --surface-color: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --console-bg: #0f172a;
            --console-text: #10b981;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #0f172a;
                --surface-color: #1e293b;
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
                --border-color: #334155;
                --primary-color: #60a5fa;
                --primary-hover: #3b82f6;
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary); height: 100vh; overflow: hidden; transition: background 0.3s; }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .p-4 { padding: 1rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        
        button { cursor: pointer; border: none; font-family: inherit; transition: 0.2s; }
        input, textarea { background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.75rem; border-radius: 0.5rem; width: 100%; font-family: inherit; }
        input:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        /* --- Loading Screen --- */
        #loading-screen { position: fixed; inset: 0; background: var(--surface-color); z-index: 50; flex-direction: column; }
        .loader-bar { width: 200px; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden; margin-top: 20px; }
        .loader-progress { width: 0%; height: 100%; background: var(--primary-color); transition: width 0.5s ease; animation: load 3s ease-in-out forwards; }
        @keyframes load { 0% { width: 0%; } 50% { width: 40%; } 100% { width: 100%; } }

        /* --- Auth Screen --- */
        .auth-card { background: var(--surface-color); padding: 2rem; border-radius: 1rem; width: 100%; max-width: 400px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); }
        .btn-primary { background: var(--primary-color); color: white; padding: 0.75rem; border-radius: 0.5rem; font-weight: 500; width: 100%; text-align: center; }
        .btn-primary:hover { background: var(--primary-hover); }
        .auth-toggle { margin-top: 1rem; text-align: center; font-size: 0.875rem; color: var(--text-secondary); cursor: pointer; }
        .auth-toggle:hover { color: var(--primary-color); }

        /* --- Dashboard --- */
        #dashboard-view { height: 100vh; display: flex; flex-direction: column; }
        header { background: var(--surface-color); border-bottom: 1px solid var(--border-color); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 700; font-size: 1.25rem; color: var(--primary-color); letter-spacing: -0.5px; }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; padding: 2rem; overflow-y: auto; flex: 1; }
        
        .project-card { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; position: relative; }
        .project-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: var(--primary-color); }
        .project-name { font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; }
        .project-url { font-size: 0.875rem; color: var(--text-secondary); font-family: 'Fira Code', monospace; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-dot.live { background-color: var(--success-color); }
        
        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 56px; height: 56px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* --- Editor --- */
        #editor-view { display: grid; grid-template-columns: 250px 1fr; height: 100vh; }
        .sidebar { background: var(--surface-color); border-right: 1px solid var(--border-color); padding: 1rem; display: flex; flex-direction: column; }
        .file-list { flex: 1; margin-top: 1rem; overflow-y: auto; }
        .file-item { padding: 0.5rem 0.75rem; margin-bottom: 0.25rem; border-radius: 0.375rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-family: 'Fira Code', monospace; font-size: 0.9rem; color: var(--text-secondary); }
        .file-item:hover { background: var(--bg-color); color: var(--text-primary); }
        .file-item.active { background: rgba(59, 130, 246, 0.1); color: var(--primary-color); border-left: 2px solid var(--primary-color); }
        .delete-file { color: var(--danger-color); opacity: 0; font-size: 1.2rem; line-height: 0.5; padding: 4px; }
        .file-item:hover .delete-file { opacity: 1; }

        .editor-main { display: flex; flex-direction: column; background: var(--bg-color); }
        .editor-toolbar { background: var(--surface-color); border-bottom: 1px solid var(--border-color); padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        #code-area { flex: 1; resize: none; border: none; padding: 1.5rem; font-family: 'Fira Code', monospace; font-size: 0.95rem; line-height: 1.6; background: var(--bg-color); color: var(--text-primary); }
        #code-area:focus { box-shadow: none; }

        /* --- Console Overlay --- */
        #console-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .console-window { width: 90%; max-width: 700px; height: 500px; background: var(--console-bg); border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #334155; }
        .console-header { background: #1e293b; padding: 0.75rem; display: flex; gap: 6px; align-items: center; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background: #ef4444; } .dot.yellow { background: #eab308; } .dot.green { background: #22c55e; }
        .console-body { flex: 1; padding: 1.5rem; overflow-y: auto; font-family: 'Fira Code', monospace; font-size: 0.9rem; color: var(--console-text); display: flex; flex-direction: column; gap: 0.5rem; }
        .log-line { opacity: 0; transform: translateY(5px); animation: fadeIn 0.2s forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* --- Preview View --- */
        #preview-container { flex: 1; background: white; position: relative; border-left: 1px solid var(--border-color); }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* --- Modal --- */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 60; display: flex; align-items: center; justify-content: center; }
        .modal { background: var(--surface-color); padding: 1.5rem; border-radius: 0.75rem; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        /* --- Toast --- */
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #111827; color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; font-size: 0.9rem; }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }

    </style>
</head>
<body>

    <div id="loading-screen" class="flex items-center justify-center">
        <h1 class="logo" style="font-size: 2rem; margin-bottom: 10px;">Nebula Cloud</h1>
        <p style="color: var(--text-secondary);">Initializing Environment...</p>
        <div class="loader-bar"><div class="loader-progress"></div></div>
    </div>

    <div id="auth-view" class="hidden flex items-center justify-center h-full">
        <div class="auth-card">
            <h2 id="auth-title" style="text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem;">Welcome Back</h2>
            <div class="flex flex-col gap-4">
                <input type="email" id="email" placeholder="Email address">
                <input type="password" id="password" placeholder="Password">
                <button class="btn-primary" onclick="handleAuth()">Sign In</button>
            </div>
            <div class="auth-toggle" onclick="toggleAuthMode()">New here? Create an account</div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <header>
            <div class="logo">Nebula Cloud</div>
            <div class="flex items-center gap-4">
                <span id="user-display" style="font-size: 0.9rem; color: var(--text-secondary);"></span>
                <button onclick="logout()" style="color: var(--danger-color); background: transparent; font-weight: 500;">Logout</button>
            </div>
        </header>
        <div id="project-list" class="project-grid">
            </div>
        <div id="empty-state" class="hidden flex flex-col items-center justify-center h-full">
            <p style="color: var(--text-secondary); font-size: 1.2rem;">No projects added yet.</p>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Click the + button to start hosting.</p>
        </div>
        <button class="fab" onclick="showCreateModal()">+</button>
    </div>

    <div id="editor-view" class="hidden">
        <div class="sidebar">
            <div class="flex items-center justify-between" style="margin-bottom: 1rem;">
                <button onclick="goHome()" style="background: transparent; color: var(--text-secondary); font-size: 0.9rem;">‚Üê Back</button>
                <strong id="editor-project-name">Project</strong>
            </div>
            <button class="btn-primary" style="font-size: 0.8rem; padding: 0.5rem;" onclick="addFilePrompt()">+ New File</button>
            <div id="file-list-container" class="file-list">
                </div>
        </div>
        <div class="editor-main">
            <div class="editor-toolbar">
                <span id="current-filename" style="color: var(--text-secondary); font-family: 'Fira Code', monospace;">index.html</span>
                <div class="flex gap-2">
                    <button class="btn-primary" style="background: var(--surface-color); color: var(--text-primary); border: 1px solid var(--border-color);" onclick="showPreview()">Preview</button>
                    <button class="btn-primary" onclick="startHostingFlow()">üöÄ START HOST</button>
                </div>
            </div>
            <textarea id="code-area" spellcheck="false" oninput="updateCurrentFile()"></textarea>
        </div>
        <div id="preview-container" class="hidden">
            <div style="background: #f1f1f1; padding: 5px 10px; border-bottom: 1px solid #ccc; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size: 0.8rem; color: #555;">Preview Mode</span>
                <button onclick="closePreview()" style="font-size: 0.8rem; color: #555; background:none;">Close ‚úï</button>
            </div>
            <iframe id="preview-frame"></iframe>
        </div>
    </div>

    <div id="create-modal" class="hidden modal-bg">
        <div class="modal">
            <h3 style="margin-bottom: 1rem;">New Project</h3>
            <input type="text" id="new-project-name" placeholder="project-slug-name" style="margin-bottom: 1rem;">
            <div class="flex justify-between">
                <button style="color: var(--text-secondary); background: transparent;" onclick="hideCreateModal()">Cancel</button>
                <button class="btn-primary" style="width: auto; padding: 0.5rem 1.5rem;" onclick="createProject()">Create</button>
            </div>
        </div>
    </div>

    <div id="console-overlay" class="hidden">
        <div class="console-window">
            <div class="console-header">
                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                <span style="margin-left: 10px; color: #94a3b8; font-size: 0.8rem;">Nebula CLI - Deploy Agent</span>
            </div>
            <div id="console-logs" class="console-body">
                </div>
        </div>
    </div>

    <div id="toast">Message</div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDSCU7uFxMBi5W3OQHb55rZz3_hXROZRdI",
            authDomain: "zor-battle.firebaseapp.com",
            databaseURL: "https://zor-battle-default-rtdb.firebaseio.com",
            projectId: "zor-battle",
            storageBucket: "zor-battle.firebasestorage.app",
            messagingSenderId: "305211042481",
            appId: "1:305211042481:web:6ebef4c35e2abd80bb9090",
            measurementId: "G-6MN7R2B870"
        };

        // --- INIT FIREBASE ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let isLoginMode = true;
        let currentProject = null;
        let activeFile = 'index.html';
        let projectFiles = {}; 

        // --- DOM ELEMENTS ---
        const views = {
            loading: document.getElementById('loading-screen'),
            auth: document.getElementById('auth-view'),
            dashboard: document.getElementById('dashboard-view'),
            editor: document.getElementById('editor-view')
        };
        const toastEl = document.getElementById('toast');
        const codeArea = document.getElementById('code-area');

        // --- LIFECYCLE ---
        window.addEventListener('load', () => {
            // Simulate loading
            setTimeout(() => {
                views.loading.classList.add('hidden');
                // Auth listener will handle the transition
            }, 3000);
        });

        // --- AUTH LOGIC ---
        auth.onAuthStateChanged(user => {
            if (views.loading.classList.contains('hidden') || user) {
                // Only switch if loading finished or auto-login
                views.loading.classList.add('hidden');
                currentUser = user;
                if (user) {
                    views.auth.classList.add('hidden');
                    views.dashboard.classList.remove('hidden');
                    document.getElementById('user-display').textContent = user.email;
                    loadProjects();
                } else {
                    views.dashboard.classList.add('hidden');
                    views.editor.classList.add('hidden');
                    views.auth.classList.remove('hidden');
                }
            }
        });

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').textContent = isLoginMode ? 'Welcome Back' : 'Create Account';
            document.querySelector('.btn-primary').textContent = isLoginMode ? 'Sign In' : 'Register';
            document.querySelector('.auth-toggle').textContent = isLoginMode ? 'New here? Create an account' : 'Already have an account? Sign In';
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, pass);
                } else {
                    await auth.createUserWithEmailAndPassword(email, pass);
                }
            } catch (error) {
                showToast(error.message);
            }
        }

        function logout() {
            auth.signOut();
        }

        // --- DASHBOARD LOGIC ---
        function loadProjects() {
            const ref = db.ref(`projects/${currentUser.uid}`);
            ref.on('value', snapshot => {
                const projects = snapshot.val();
                const list = document.getElementById('project-list');
                const empty = document.getElementById('empty-state');
                list.innerHTML = '';
                
                if (!projects) {
                    list.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }

                list.classList.remove('hidden');
                empty.classList.add('hidden');

                Object.keys(projects).forEach(key => {
                    const div = document.createElement('div');
                    div.className = 'project-card';
                    div.onclick = () => openProject(key);
                    div.innerHTML = `
                        <div class="project-name">${key}</div>
                        <div class="project-url">
                            <span class="status-dot live"></span>${key}.nebula.app
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function showCreateModal() {
            document.getElementById('create-modal').classList.remove('hidden');
            document.getElementById('new-project-name').value = '';
        }
        function hideCreateModal() {
            document.getElementById('create-modal').classList.add('hidden');
        }

        async function createProject() {
            const name = document.getElementById('new-project-name').value.trim().toLowerCase();
            const slugRegex = /^[a-z0-9-]+$/;

            if (!name || !slugRegex.test(name)) {
                showToast("Name must be lowercase, numbers, or dashes only.");
                return;
            }

            const defaultFiles = {
                "index.html": `<!DOCTYPE html>\n<html>\n<head>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>Hello ${name}!</h1>\n  <p>Welcome to your new cloud project.</p>\n  <script src="script.js"><\/script>\n</body>\n</html>`,
                "style.css": `body {\n  font-family: sans-serif;\n  background: #f0f0f0;\n  text-align: center;\n  padding-top: 50px;\n}\nh1 { color: #3b82f6; }`,
                "script.js": `console.log('Nebula Cloud is running!');`
            };

            await db.ref(`projects/${currentUser.uid}/${name}`).set({
                created: Date.now(),
                files: defaultFiles
            });

            hideCreateModal();
            showToast("Project created successfully");
        }

        // --- EDITOR LOGIC ---
        async function openProject(name) {
            currentProject = name;
            views.dashboard.classList.add('hidden');
            views.editor.classList.remove('hidden');
            document.getElementById('editor-project-name').textContent = name;
            
            // Fetch files once
            const snapshot = await db.ref(`projects/${currentUser.uid}/${name}/files`).once('value');
            projectFiles = snapshot.val() || {};
            
            // Ensure index.html exists conceptually for UI, even if empty
            if (Object.keys(projectFiles).length === 0) {
                projectFiles["index.html"] = "";
            }
            
            activeFile = Object.keys(projectFiles)[0];
            renderFileList();
            loadCodeToEditor();
        }

        function goHome() {
            saveCurrentFileToMemory(); // Save pending changes to memory object before leaving
            views.editor.classList.add('hidden');
            views.dashboard.classList.remove('hidden');
            document.getElementById('preview-container').classList.add('hidden');
            document.querySelector('.editor-main').style.display = 'flex';
        }

        function renderFileList() {
            const container = document.getElementById('file-list-container');
            container.innerHTML = '';
            
            Object.keys(projectFiles).forEach(fileName => {
                const item = document.createElement('div');
                item.className = `file-item ${fileName === activeFile ? 'active' : ''}`;
                item.onclick = (e) => {
                    if(e.target.classList.contains('delete-file')) return;
                    switchFile(fileName);
                };
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = fileName;
                
                const delBtn = document.createElement('span');
                delBtn.innerHTML = '√ó';
                delBtn.className = 'delete-file';
                delBtn.onclick = () => deleteFile(fileName);

                item.appendChild(nameSpan);
                item.appendChild(delBtn);
                container.appendChild(item);
            });
        }

        function switchFile(fileName) {
            saveCurrentFileToMemory();
            activeFile = fileName;
            renderFileList();
            loadCodeToEditor();
        }

        function loadCodeToEditor() {
            document.getElementById('current-filename').textContent = activeFile;
            codeArea.value = projectFiles[activeFile] || '';
        }

        function updateCurrentFile() {
            // Update memory object on every keystroke
            projectFiles[activeFile] = codeArea.value;
        }

        function saveCurrentFileToMemory() {
            if (activeFile) {
                projectFiles[activeFile] = codeArea.value;
            }
        }

        function addFilePrompt() {
            const name = prompt("Enter file name (e.g., style.css):");
            if (!name) return;
            if (!name.includes('.')) {
                showToast("File must have an extension.");
                return;
            }
            if (projectFiles[name]) {
                showToast("File already exists.");
                return;
            }
            
            projectFiles[name] = "";
            switchFile(name);
        }

        function deleteFile(name) {
            if (Object.keys(projectFiles).length <= 1) {
                showToast("Cannot delete the last file.");
                return;
            }
            if(confirm(`Delete ${name}?`)) {
                delete projectFiles[name];
                if(activeFile === name) {
                    activeFile = Object.keys(projectFiles)[0];
                }
                renderFileList();
                loadCodeToEditor();
            }
        }

        // --- DEPLOYMENT LOGIC ---
        function startHostingFlow() {
            saveCurrentFileToMemory();
            
            // Validation
            let hasIndex = Object.keys(projectFiles).includes('index.html');
            if(!hasIndex) {
                if(!confirm("Critical Error: 'index.html' is missing. The site will not load correctly. Continue anyway?")) {
                    return;
                }
            }

            // Start Console Animation
            const overlay = document.getElementById('console-overlay');
            const logsDiv = document.getElementById('console-logs');
            overlay.classList.remove('hidden');
            logsDiv.innerHTML = '';

            const steps = [
                "Initializing Hosting Engine...",
                "Connecting to Nebula Cloud Region (us-east-1)...",
                "Allocating RAM and CPU resources...",
                "Checking dependency tree...",
                `Found ${Object.keys(projectFiles).length} files to process.`,
                "Validating syntax...",
                "Optimizing assets...",
                "Building project...",
                "Deploying to Edge Network...",
                "Finalizing DNS configuration...",
                "Hosting Started Successfully! üöÄ"
            ];

            let delayTotal = 0;
            steps.forEach((step, index) => {
                const delay = Math.random() * 800 + 400; // Random delay between 400ms and 1200ms
                delayTotal += delay;
                
                setTimeout(() => {
                    const p = document.createElement('div');
                    p.className = 'log-line';
                    p.textContent = `> ${step}`;
                    logsDiv.appendChild(p);
                    logsDiv.scrollTop = logsDiv.scrollHeight;

                    // Final step action
                    if (index === steps.length - 1) {
                        finishDeploy();
                    }
                }, delayTotal);
            });
        }

        async function finishDeploy() {
            // Save to Firebase
            await db.ref(`projects/${currentUser.uid}/${currentProject}/files`).set(projectFiles);
            
            setTimeout(() => {
                document.getElementById('console-overlay').classList.add('hidden');
                showToast("Deployment Complete!");
                showPreview(); // Auto open preview
            }, 1500);
        }

        // --- PREVIEW LOGIC ---
        function showPreview() {
            const previewContainer = document.getElementById('preview-container');
            const editorMain = document.querySelector('.editor-main');
            const iframe = document.getElementById('preview-frame');

            // Hide editor, show preview
            editorMain.style.display = 'none';
            previewContainer.classList.remove('hidden');

            // Build source
            let htmlContent = projectFiles['index.html'] || "<h1>No index.html found</h1>";

            // Inject CSS
            // Simple regex to find <link rel="stylesheet" href="...">
            htmlContent = htmlContent.replace(/<link[^>]+href=["'](.*?)["'][^>]*>/g, (match, href) => {
                if (projectFiles[href]) {
                    return `<style>${projectFiles[href]}</style>`;
                }
                return match;
            });

            // Inject JS
            // Simple regex to find <script src="..."></script>
            htmlContent = htmlContent.replace(/<script[^>]+src=["'](.*?)["'][^>]*><\/script>/g, (match, src) => {
                if (projectFiles[src]) {
                    // Wrap in try-catch for safety in preview
                    return `<script>try { ${projectFiles[src]} } catch(e) { console.error(e); }<\/script>`;
                }
                return match;
            });

            iframe.srcdoc = htmlContent;
        }

        function closePreview() {
            document.getElementById('preview-container').classList.add('hidden');
            document.querySelector('.editor-main').style.display = 'flex';
        }

        // --- UTIL ---
        function showToast(msg) {
            toastEl.textContent = msg;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        }

        // --- PUBLIC LINK CHECKER (Optional Logic) ---
        // If URL has ?uid=...&project=..., load in read-only mode
        const urlParams = new URLSearchParams(window.location.search);
        const publicUid = urlParams.get('uid');
        const publicProj = urlParams.get('project');

        if (publicUid && publicProj) {
            // Override Auth flow for public view
            views.loading.classList.remove('hidden');
            views.auth.classList.add('hidden');
            
            db.ref(`projects/${publicUid}/${publicProj}/files`).once('value').then(snap => {
                views.loading.classList.add('hidden');
                const files = snap.val();
                if(files) {
                    projectFiles = files;
                    // Mock UI specifically for preview only
                    document.body.innerHTML = '';
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100vw';
                    iframe.style.height = '100vh';
                    iframe.style.border = 'none';
                    document.body.appendChild(iframe);
                    
                    // Same render logic
                    let html = files['index.html'] || "";
                    html = html.replace(/<link[^>]+href=["'](.*?)["'][^>]*>/g, (m, h) => files[h] ? `<style>${files[h]}</style>` : m);
                    html = html.replace(/<script[^>]+src=["'](.*?)["'][^>]*><\/script>/g, (m, s) => files[s] ? `<script>${files[s]}<\/script>` : m);
                    iframe.srcdoc = html;
                } else {
                    alert('Project not found');
                }
            });
        }

    </script>
</body>
</html>
